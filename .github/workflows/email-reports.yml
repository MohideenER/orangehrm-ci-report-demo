name: Email and reporting

on : 
  workflow_dispatch
jobs:
  run-test:
    uses:  ./.github/workflows/test-and-report.yml

  generate-report:
    needs : run-test
    runs-on: ubuntu-latest

    steps:
      - name: Download allure results
        uses: actions/download-artifact@v4
        with:
            name: allure-results
            path: allure-results
            # path: . 

      - name: List Allure Results Files - did for debugging
        run: |
          echo "Contents of allure-results folder:"
          ls -R allure-results
          echo "Check if container.json exists:"
          find allure-results -name container.json || echo "container.json not found"

      - name: Install Allure CLI
        run: |
          curl -o allure.tgz -L https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
          tar -xzf allure.tgz
          sudo mv allure-2.27.0 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/bin/allure
          
      - name: Generate Allure report
        run: allure generate allure-results -o allure-report --clean

      - name: List Allure Report contents - did for debugging
        run: ls -R allure-report

      - name: Upload the generated Allure report folder
        uses: actions/upload-artifact@v4
        with:
           name: allure-report
           path: allure-report

      # - name: Deploy Allure report to GitHub Pages
      #   uses: peaceiris/actions-gh-pages@v3
      #   with:
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
      #     publish_branch: gh-pages
      #     publish_dir: allure-report
           
  send-report-and-link: 
    needs: generate-report
    runs-on: ubuntu-latest
    steps:
    
       # COmmenting the below to send the report directly instead of send the report and open in local web browser.   
      - name: Download the generated Allure report
        uses: actions/download-artifact@v4
        with:
           name: allure-report
           path: ./allure-report

      - name: Zip the Allure report for attachment
        run: zip -r allure-report.zip ./allure-report

      - name: Archive Allure report as tar.gz
        run: tar -czf allure-report.tar.gz ./allure-report

           
      - name: Send the Allure report and link
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: mohideen.er22@gmail.com
          password: ${{ secrets.SEND_MAIL_PASSWORD }}
          subject: "Allure Report Generated"
          to: ostan@codecraft.co.in
          from: GitHub CI <mohideen.er22@gmail.com>
          content_type: html

          body: |
            
            Hello all,
            
            PFA,   
            The Allure test report.
            
            You can also download it directly from here:
            # View the live report:  https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            View the report : https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/

            # View the report directly from workflow run : <a href=" https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/?run_id=${{ github.run_id }}">Report....</a>

            View workflow run details: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            
            Regards,
            CI System 
            
          # attachments: allure-report.tar.gz    - # Not accepting by gmail - blocks all - ZIP, ZIPX, TAR, TAR.GZ.

         
  
